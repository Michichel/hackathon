<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Hisporés Login</title>
    <link rel="icon" href="../MEDIA/Logo.png" type="image/png" sizes="64x64">
    <link href="../CSS/styles.css" rel="stylesheet">
</head>

<body style="background-image: url(../MEDIA/background.jpg);">
    <div class="fondo">
        <div class="shapes"></div>
        <div class="shapes"></div>
    </div>

    <form id="loginForm">
        <h3>Inicio de Sesión</h3>
        <label for="email">Correo Electrónico
            <input type="email" placeholder="Email" id="email" required>
        </label>

        <label for="password">Contraseña
            <input type="password" placeholder="Contraseña" id="password" required>
        </label>
        <input type="submit" id="ingresar01" class="login" value="Ingresar" />

        <div class="form">
            <p>Aún no posees una cuenta? <a href="/HTML/register.html">Registrarse</a></p>
        </div>
    </form>

    <script type="module">
        // Importar las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

        // Configuración de Firebase (asegúrate de que estos datos son correctos y corresponden a tu proyecto)
        const firebaseConfig = {
            apiKey: "AIzaSyAW3-ZyIRxtaWpN6upO28Dy9xup_8ANTug",
            authDomain: "database-bdad6.firebaseapp.com",
            projectId: "database-bdad6",
            storageBucket: "database-bdad6.appspot.com",
            messagingSenderId: "983982590456",
            appId: "1:983982590456:web:08dc134f06628a28336e0d"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth();

        // Obtener referencia al formulario
        const loginForm = document.getElementById('loginForm');

        // Manejar el evento de envío del formulario
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault(); // Prevenir el comportamiento por defecto del formulario

            // Obtener los valores de los campos de entrada
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            // Validar que los campos no estén vacíos
            if (email === "" || password === "") {
                alert("Por favor, completa todos los campos.");
                return;
            }

            // Autenticar al usuario con Firebase
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Inicio de sesión exitoso
                    const user = userCredential.user;
                    const dt = new Date().toISOString(); // Fecha en formato ISO

                    // Actualizar 'last_login' en la base de datos
                    update(ref(database, 'users/' + user.uid), {
                        last_login: dt,
                    })
                    .then(() => {
                        alert('Inicio de sesión exitoso.');
                        // Redirigir al usuario a la página principal
                        window.location.href = 'first_page.html';
                    })
                    .catch((error) => {
                        console.error('Error al actualizar last_login:', error);
                        alert('Error al actualizar la base de datos.');
                    });
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    // Personalizar mensajes de error según el código de error
                    switch(errorCode) {
                        case 'auth/invalid-email':
                            alert('El correo electrónico no es válido.');
                            break;
                        case 'auth/user-disabled':
                            alert('Este usuario ha sido deshabilitado.');
                            break;
                        case 'auth/user-not-found':
                            alert('No se encontró un usuario con este correo electrónico.');
                            break;
                        case 'auth/wrong-password':
                            alert('La contraseña es incorrecta.');
                            break;
                        default:
                            alert('Error: ' + errorMessage);
                    }
                });
        });
    </script>
</body>
<footer>
    <div class="container">
        <p>&copy; Hisporés hackaton</p>
    </div>
</footer>
</html>
